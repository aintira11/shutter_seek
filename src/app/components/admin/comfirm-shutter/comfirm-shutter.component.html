<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
</head>

<body>

  <div class="box" (click)="back()">
    <div class="arrow right"></div>
    <div class="text">กลับ</div>
  </div>

  <div class="admin-container">

    <header class="admin-header">
      <div class="admin-profile">
        <img class="profile-avatar" [src]="datauser[0].image_profile" alt="Admin Profile" (click)="profile()" />
        <span class="profile-name">{{ datauser[0].username }}</span>
        <button class="add-btn" (click)="goToadd()">+</button>
      </div>

      <div class="logo-center">
        <img src="/assets/images/PIXEL (8).png" alt="Shutter Seek Logo" class="center-logo" />
      </div>

      <button class="logout-btn" (click)="goToLogin()">ออกจากระบบ</button>
    </header>

    <div style="position: relative; display: flex; justify-content: center; align-items: center; height: 120px;">
      <h1 style="margin: 0;">อนุมัติช่างภาพ</h1>
      <button mat-raised-button color="primary" (click)="Approval()" style="position: absolute; right: 20px;">
        ✏️ แก้ไขเกณฑ์การอนุมัติ
      </button>
    </div>

    <div class="tabs">
      <button (click)="filterUsers(1)" [class.active]="selectedTab === 1">รอ ({{ pending }})</button>
      <button (click)="filterUsers(2)" [class.active]="selectedTab === 2">อนุมัติ ({{ comfirm }})</button>
      <button (click)="filterUsers(3)" [class.active]="selectedTab === 3">ปฏิเสธ ({{ refuse }})</button>
    </div>

    <div *ngFor="let user of datafilterUsers" class="user-card">
      <img [src]="user.image_profile" alt="User Avatar" class="avatar" />

      <div class="user-info">
        <h3>{{ user.username }}</h3>
        <p class="role" *ngIf="user.sht_status == 1">รอ</p>
        <p class="role" *ngIf="user.sht_status == 2">อนุมัติ</p>
        <p class="role" *ngIf="user.sht_status == 3">ปฏิเสธ</p>
      </div>

      <div class="actions" *ngIf="selectedTab === 1">
        <button class="pushable detail">
          <span class="front">รายละเอียด</span>
        </button>

        <button class="pushable" (click)="approveUser(user.user_id)">
          <span class="front">อนุมัติ</span>
        </button>

        <button class="pushable deny" (click)="openRejectModal(user.user_id)">
          <span class="front">ปฏิเสธ</span>
        </button>
      </div>

      <div class="actions" *ngIf="selectedTab === 2">
        <button class="pushable deny" (click)="openRejectModal(user.user_id)">
          <span class="front">ปฏิเสธ</span>
        </button>
      </div>

      <div class="actions" *ngIf="selectedTab === 3">
        <button class="pushable detail" (click)="openViewReasonsModal(user.user_id)">
          <span class="front">ดูเหตุผล</span>
        </button>
        <button class="pushable" (click)="approveUser(user.user_id)">
          <span class="front">อนุมัติ</span>
        </button>
      </div>
    </div>

  </div>

  <div class="modal-overlay" *ngIf="isRejectModalOpen">
    <div class="modal-content">
      <h2>เลือกเหตุผลการปฏิเสธ</h2>
      <div class="reasons-list">
        <div *ngIf="approvalCategories.length === 0 && !isLoading && !hasError" class="no-criteria-message">
          ไม่มีเกณฑ์การปฏิเสธที่กำหนดไว้ กรุณาเพิ่มเกณฑ์ในหน้าแก้ไขเกณฑ์การอนุมัติ
        </div>
        <div *ngIf="isLoading" class="loading-message">
          กำลังโหลดเกณฑ์...
        </div>
        <div *ngIf="hasError" class="error-message">
          เกิดข้อผิดพลาดในการโหลดเกณฑ์การปฏิเสธ
        </div>

        <div *ngFor="let category of approvalCategories" class="category-group">
          <h3>{{ category.title }}</h3>
          <div *ngFor="let subCriterion of category.subCriteria">
            <label *ngIf="subCriterion.isEnabled">
              <input type="checkbox" [checked]="selectedRejectionReasons[subCriterion.id]"
                (change)="toggleReasonSelection(subCriterion.id)" />
              {{ subCriterion.text }}
            </label>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button mat-raised-button color="warn" (click)="cancelReject()">ยกเลิก</button>
        <button mat-raised-button color="primary" (click)="confirmRejectUser()">ยืนยันการปฏิเสธ</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" *ngIf="isViewReasonsModalOpen">
    <div class="modal-content">
      <h2>เหตุผลการปฏิเสธ</h2>
      <div class="reasons-list">
        <ul *ngIf="reasonsToDisplay.length > 0; else noReasons">
          <li *ngFor="let reason of reasonsToDisplay">
            <strong>{{ reason.categoryTitle }}:</strong> {{ reason.reasonText }}
          </li>
        </ul>
        <ng-template #noReasons>
          <p class="no-criteria-message">ไม่พบเหตุผลการปฏิเสธสำหรับผู้ใช้คนนี้</p>
        </ng-template>
      </div>
      <div class="modal-actions">
        <button mat-raised-button color="primary" (click)="closeViewReasonsModal()">ปิด</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" *ngIf="isChatMessagePreviewModalOpen">
    <div class="modal-content">
      <h3>{{ chatMessagePreviewTitle }}</h3>

      <div class="chat-message-preview" style="white-space: pre-wrap; word-wrap: break-word;">
        <p>{{ chatMessagePreviewContent }}</p>
      </div>

      <div class="modal-actions">
        <button mat-button (click)="closeChatMessagePreviewModal()">ยกเลิก</button>
        <button mat-raised-button color="primary" (click)="sendChatAndConfirmStatus()">
          ยืนยันและส่งข้อความ
        </button>
      </div>
    </div>
  </div>

</body>

</html>