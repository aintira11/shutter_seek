<div class="chat-container">
  <div class="chat-sidebar">
    <div class="sidebar-header">
      <h3>üí¨ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</h3>
      <div class="sidebar-subtitle">
        <ng-container *ngIf="myUserType === '1'">‡∏ä‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏Ñ‡∏∏‡∏¢‡∏î‡πâ‡∏ß‡∏¢</ng-container>
        <ng-container *ngIf="myUserType === '2'">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡∏Å‡∏´‡∏≤‡∏Ñ‡∏∏‡∏ì</ng-container>
      </div>
    </div>

    <div class="chat-list">
      <div
        class="chat-item"
        *ngFor="let room of chatRooms"
        [class.active]="selectedPartnerId === room.partnerId"
        (click)="setupChat(room.partnerId)"
      >
        <ng-container *ngIf="getChatPartnerInfo(room.partnerId) as partner">
          <div class="photographer-avatar">
            <img *ngIf="partner.image_profile; else noProfileImage" [src]="partner.image_profile" alt="Profile" class="profile-img">
            <ng-template #noProfileImage>
              {{ partner.username ? partner.username.charAt(0).toUpperCase() : '?' }}
            </ng-template>
            <span class="status-indicator" [class.online]="getPartnerStatus(partner.user_id) === 'online'"></span>
          </div>
          <div class="chat-info">
            <div class="photographer-name">{{ partner.username }}</div>
            <div class="last-message">{{ room.lastMessage }}</div>
          </div>
          <div class="message-time">{{ room.lastMessageTime | date:'shortTime' }}</div>
        </ng-container>
      </div>
    </div>
  </div>

  <div class="chat-main" *ngIf="selectedPartnerId; else noChatSelected">
    <div class="chat-header">
      <div class="chat-header-avatar">
        <ng-container *ngIf="getChatPartnerInfo(selectedPartnerId) as currentPartner">
          <img *ngIf="currentPartner.image_profile; else noCurrentProfileImage" [src]="currentPartner.image_profile" alt="Profile" class="profile-img">
          <ng-template #noCurrentProfileImage>
            {{ currentPartner.username ? currentPartner.username.charAt(0).toUpperCase() : '?' }}
          </ng-template>
        </ng-container>
      </div>
      <div class="chat-header-info">
        <h3>{{ getChatPartnerInfo(selectedPartnerId)?.username }}</h3>
        <div class="chat-header-status">
          <span [ngClass]="{'status-dot': true, 'online': getPartnerStatus(selectedPartnerId) === 'online'}"></span>
          {{ getPartnerStatus(selectedPartnerId) === 'online' ? '‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå' : '‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå' }}
        </div>
      </div>
    </div>

    <div class="messages" #messagesContainer>
      <div *ngFor="let msg of messages" [ngClass]="{'my-message': msg.senderId === myId, 'other-message': msg.senderId !== myId}">
        <div class="message-bubble">
          <ng-container *ngIf="isImageUrl(msg.messageText); else textMessage">
            <img [src]="msg.messageText" alt="Image" class="chat-image" (load)="onImageLoad()">
          </ng-container>
          <ng-template #textMessage>
            {{ msg.messageText}}
          </ng-template>
          <div class="message-time">
            {{ msg.timestamp | date:'HH:mm' }}
            <ng-container *ngIf="msg.senderId === myId">
              <span class="read-status" [class.read]="msg.isRead" title="{{ msg.isRead ? '‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß' : '‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß' }}">
                <ng-container *ngIf="msg.isRead">‚úî‚úî</ng-container>
                <ng-container *ngIf="!msg.isRead">‚úî</ng-container>
              </span>
            </ng-container>
          </div>
        </div>
      </div>
    </div>

    <div class="input-box">
      <div *ngIf="files.length > 0" class="image-preview-container">
        <div *ngFor="let fileObj of files; let i = index" class="image-preview-item">
          <img [src]="fileObj.preview" alt="Preview" class="preview-img">
          <button (click)="removeFile(i)" class="remove-image-button">x</button>
        </div>
      </div>

      <div class="message-input-area"> <label for="image-upload" class="image-upload-button">üì∏</label>
        <input type="file" id="image-upload" (change)="onFileSelect($event)" accept="image/jpeg, image/png" multiple style="display: none;">

        <input [(ngModel)]="newMessage" (keydown.enter)="sendMessage()" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." class="message-input">
        <button (click)="sendMessage()" class="send-button" [disabled]="isUploading"> <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <ng-template #noChatSelected>
    <div class="no-chat-selected">
      <div class="icon">üí¨</div>
      <h3>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤</h3>
      <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤</p>
    </div>
  </ng-template>
</div>